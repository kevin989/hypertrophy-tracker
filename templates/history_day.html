{% extends "base.html" %}
{% block content %}

<style>
  .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:50}
  .modal-inner{background:#fff;border-radius:1rem;padding:1rem;max-width:1000px;width:96%;max-height:85vh;overflow:auto}
</style>

<!-- Week navigation -->
<div class="flex items-center justify-between mb-3">
  <a class="btn-secondary" href="{{ url_for('week_view', week=week-1 if week>1 else 1) }}">← Prev</a>
  <div class="badge">Program V1.0</div>
  <a class="btn-secondary" href="{{ url_for('week_view', week=week+1 if week<12 else 12) }}">Next →</a>
</div>

<!-- Bodyweight -->
<div class="card mb-4">
  <form method="post" class="flex items-end gap-3">
    <div>
      <label class="block text-sm text-gray-600 mb-1">Bodyweight ({{units}})</label>
      <input class="input w-32" type="number" step="0.1" name="bodyweight" value="{{ bw or '' }}">
    </div>
    <button class="btn" type="submit">Save Bodyweight</button>
  </form>
</div>

<!-- Days list -->
{% for title, sub in grouped %}
  {% set day = loop.index %}
  <div class="card mb-3">
    <div class="flex items-center justify-between">
      <h3 class="text-lg font-semibold">
        {{ title }}
        <span id="timer-{{day}}" class="badge ml-2">Not started</span>
      </h3>
      <div class="space-x-2">
        <button class="btn-secondary" type="button" onclick="document.getElementById('modal-{{day}}').style.display='flex'">Open</button>
      </div>
    </div>
  </div>

  <!-- Modal for this day -->
  <div id="modal-{{day}}" class="modal" onclick="if(event.target===this)this.style.display='none'">
    <div class="modal-inner">
      <div class="flex items-center justify-between mb-2">
        <h4 class="text-lg font-semibold">{{ title }}</h4>
        <button class="btn-ghost" type="button" onclick="document.getElementById('modal-{{day}}').style.display='none'">Close</button>
      </div>

      <form id="form-day-{{day}}" method="post">
        <!-- hidden timer fields -->
        <input type="hidden" id="start-{{day}}" name="start_{{day}}">
        <input type="hidden" id="end-{{day}}"   name="end_{{day}}">
        <input type="hidden" name="save_day" value="{{day}}">

        <table class="table">
          <thead>
            <tr>
              <th>Exercise</th>
              <th>Sets</th>
              <th>Rep Target</th>
              <th>Suggested ({{units}})</th>
              <th>Load (this week, {{units}})</th>
              <th>S1</th>
              <th>S2</th>
              <th>S3</th>
              <th>New Load ({{units}})</th>
              <th>Notes</th>
            </tr>
          </thead>
          <tbody>
          {% for r in sub %}
            <tr>
              <td>{{ r.exercise }}</td>
              <td>{{ r.sets }}</td>

              <!-- Rep Target: add '+' for accessories to indicate S3 is AMRAP -->
              <td>
                {% if r.category == 'accessory' %}
                  {{ r.rep_low }}–{{ r.rep_high }}+
                {% else %}
                  {{ r.rep_low }}–{{ r.rep_high }}
                {% endif %}
              </td>

              <!-- Suggested (display only) -->
              <td>{{ r.load_last if r.load_last is not none else '' }}</td>

              <!-- Actual load used this week -->
              <td>
                <input class="input w-24" type="number" step="0.5"
                       name="row_{{ r.id }}_load"
                       oninput="markInput({{day}})"
                       placeholder="{{ r.load_last if r.load_last is not none else '' }}">
              </td>

              <!-- Rep entries -->
              <td><input class="input w-16" type="number" name="row_{{ r.id }}_s1" min="0" step="1" oninput="markInput({{day}})"></td>
              <td><input class="input w-16" type="number" name="row_{{ r.id }}_s2" min="0" step="1" oninput="markInput({{day}})"></td>

              <!-- S3: for accessories, this is the AMRAP set (no separate column) -->
              <td><input class="input w-16" type="number" name="row_{{ r.id }}_s3" min="0" step="1" oninput="markInput({{day}})"
                         placeholder="{% if r.category == 'accessory' %}AMRAP{% endif %}"></td>

              <td>{{ r.new_load if r.new_load is not none else '' }}</td>
              <td><input class="input" type="text" name="row_{{ r.id }}_notes"></td>
            </tr>
          {% endfor %}
          </tbody>
        </table>

        <div class="flex items-center justify-end mt-3">
          <button type="button" class="btn" onclick="endDay({{day}})">Save Day</button>
        </div>
      </form>
    </div>
  </div>
{% endfor %}

<script>
  // Start a timer the first time any input is edited per day; stop when "Save Day" is clicked.
  let dayTimers = {};  // { day: { start: Date } }

  function markInput(day){
    if(!dayTimers[day] || !dayTimers[day].start){
      dayTimers[day] = { start: new Date() };
      const badge = document.getElementById('timer-'+day);
      if(badge) badge.textContent = "⏱ Started";
      const hiddenStart = document.getElementById('start-'+day);
      if(hiddenStart) hiddenStart.value = new Date().toISOString();
    }
  }

  function endDay(day){
    const startISO = (document.getElementById('start-'+day) || {}).value;
    if(startISO){
      const endInput = document.getElementById('end-'+day);
      if(endInput) endInput.value = new Date().toISOString();
    }
    document.getElementById('form-day-'+day).submit();
  }
</script>

{% endblock %}
